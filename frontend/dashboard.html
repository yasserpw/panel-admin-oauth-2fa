<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Panel Admin OAuth 2.0</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .dashboard-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
      padding: 40px;
      text-align: center;
    }

    .logo {
      font-size: 60px;
      margin-bottom: 20px;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      margin-right: auto;
      background: #f0f0f0;
    }

    .user-info {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .user-info h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .user-info p {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }

    .label {
      font-weight: 600;
      color: #333;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
    }

    .btn-logout {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      width: 100%;
    }

    .btn-logout:hover {
      background-color: #c82333;
      transform: translateY(-2px);
    }

    .loading {
      text-align: center;
      color: #667eea;
      font-size: 18px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Cargando...</p>
    </div>

    <div id="dashboard" style="display: none;">
      <div class="success-message">
        ‚úÖ Autenticaci√≥n Exitosa
      </div>

      <div class="logo">üìä</div>

      <div class="user-info">
        <h2 id="userName">Usuario</h2>
        <p><span class="label">Email:</span> <span id="userEmail">-</span></p>
        <p><span class="label">Verificado:</span> <span id="userVerified">-</span></p>
      </div>

      <div style="background: #e7f3ff; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
        <p style="color: #004085; font-size: 12px;">
          üîí Informaci√≥n de Sesi√≥n
        </p>
        <p style="color: #004085; font-size: 12px; margin-top: 5px;">
          <strong>Token guardado en:</strong> Cookie HttpOnly + LocalStorage
        </p>
        <p style="color: #004085; font-size: 12px;">
          <strong>Duraci√≥n:</strong> 24 horas
        </p>
      </div>

      <button class="btn-logout" id="logoutBtn">
        üö™ Cerrar sesi√≥n
      </button>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://panel-admin-oauth-backend.onrender.com';
    const loading = document.getElementById('loading');
    const dashboard = document.getElementById('dashboard');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userVerified = document.getElementById('userVerified');
    const logoutBtn = document.getElementById('logoutBtn');

    // ‚úÖ Cargar datos del usuario desde URL o localStorage
    function loadUserData() {
      // Intentar obtener datos de la URL (par√°metro user)
      const urlParams = new URLSearchParams(window.location.search);
      const userParam = urlParams.get('user');

      let userData = null;

      if (userParam) {
        try {
          userData = JSON.parse(decodeURIComponent(userParam));
          // Guardar en localStorage para que persista
          localStorage.setItem('userData', JSON.stringify(userData));
        } catch (e) {
          console.error('Error parsing user data from URL:', e);
        }
      }

      // Si no hay en URL, intentar localStorage
      if (!userData) {
        const stored = localStorage.getItem('userData');
        if (stored) {
          try {
            userData = JSON.parse(stored);
          } catch (e) {
            console.error('Error parsing stored user data:', e);
          }
        }
      }

      return userData;
    }

    // ‚úÖ Mostrar datos del usuario
    function displayUserData(userData) {
      if (userData) {
        userName.textContent = userData.name || 'Usuario';
        userEmail.textContent = userData.email || '-';
        userVerified.textContent = userData.verified_email ? '‚úÖ S√≠' : '‚ùå No';

        loading.style.display = 'none';
        dashboard.style.display = 'block';
      } else {
        loading.innerHTML = '<p>No se encontraron datos de usuario. Intenta loguear nuevamente.</p>';
      }
    }

    // ‚úÖ Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        logoutBtn.disabled = true;
        logoutBtn.textContent = 'Cerrando...';

        const response = await fetch(`${BACKEND_URL}/logout`, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        // Limpiar localStorage
        localStorage.removeItem('userData');

        // Limpiar cookies (intenta)
        document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

        // Redirigir a login
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 500);

      } catch (error) {
        console.error('Error al cerrar sesi√≥n:', error);
        logoutBtn.disabled = false;
        logoutBtn.textContent = 'üö™ Cerrar sesi√≥n';
        alert('Error al cerrar sesi√≥n: ' + error.message);
      }
    });

    // ‚úÖ Inicializar
    const userData = loadUserData();
    displayUserData(userData);
  </script>
</body>
</html>
